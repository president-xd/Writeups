FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -yq \
    build-essential \
    cmake \
    libssl-dev \
    python3 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /chall

COPY dist/emp-tool /chall/emp-tool
COPY dist/emp-ot /chall/emp-ot
COPY dist/emp-zk /chall/emp-zk
COPY dist/install.py /chall/install.py

# Replace client with our exploit client
COPY exploit/client.cpp /chall/emp-zk/test/arith/client.cpp
COPY exploit/solve.py /chall/solve.py

# Build deps, emp-tool, emp-ot via install.py (skip --zk to avoid building all targets)
RUN python3 install.py --deps --tool --ot

# Build only the client target from emp-zk
RUN cd /chall/emp-zk && cmake . && make test_arith_client -j$(nproc)

CMD ["python3", "/chall/solve.py"]
